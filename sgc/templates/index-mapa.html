{% load staticfiles %}
<!DOCTYPE html>
<html>
<head>
	<title>Mapa</title>
	<meta charset="utf-8" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="http://leafletjs.com/dist/leaflet.css" />

	<!-- Bootstrap-->
	<link rel="stylesheet" href="{% static 'sgc/css/bootstrap.css' %}" />

	<!-- Bootstrap theme  -->
	<link rel="stylesheet" href="{% static 'sgc/css/bootstrap-theme.css' %}" />

	<style>
		html { padding-top: 52px; height: 100%; }
		body { height: 100%; position: relative; }
		.navbar-brand {
			height: 50px;
			padding: 5px;
		}
		.navbar-nav > li > a {
			line-height: 0px;
			padding-bottom: 22px;
		}
		.desplegable-window {
			position: absolute;
			top: 0;
			right: 0;
			width: 350px;
			height: 100%;
			z-index: 1;
		}
		.bg-dark-blue label {
			color: white;
		}
		.navbar-default .navbar-nav > li > a {
			color: white;
		}
	</style>
</head>
<body>
	
	<!-- Modal -->
	<div class="modal fade" id="resultadosBusquedaModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" id="myModalLabel">Resultados de búsqueda</h4>
				</div>
				<div class="modal-body">
					<div class="panel-group" id="accordionlista_resultados" role="tablist" aria-multiselectable="true">
					</div>
				</div>
			</div>
		</div>
	</div>


	<div class="desplegable-window" style="display:none;">
		<div class="panel panel-default bg-dark-blue">
			<div class="panel-body bg-dark-blue">
				<form action="">
					<div class="form-group">
						<label for="combo1">Área temática</label>
						<select name="combo1" id="combo1" class="form-control">
							{% for area in areasTematicas %}
								<option value="{{ area.id }}">{{ area }}</option>
							{% endfor %}
						</select>
					</div>
					<div class="form-group">
						<input type="submit" name="submit" id="submit" class="btn btn-success form-control" value="Buscar" />
					</div>
				</form>
			</div>
		</div>
	</div>

	<nav class="navbar navbar-default navbar-fixed-top bg-dark-blue">
		<div class="container-fluid">
			<!-- Brand and toggle get grouped for better mobile display -->
			<div class="col-lg-12">
				<div class="col-md-3">
					<div class="navbar-header">
						<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
							<span class="sr-only">Toggle navigation</span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
						</button>
						
						<a href="{% url 'sgc.views.home' %}"><img src="{% static 'sgc/img/single-logo-border.png' %}" alt="" class="navbar-brand" /></a>
					</div>
				</div>
				<div class="col-md-6 text-center">
					<form class="navbar-form" role="search" id="formularioBusqueda" method="post">
				        <div class="form-group">
				          <input type="text" id="busqueda" class="form-control" placeholder="Búsqueda">
				        </div>
				        <button type="submit" class="btn btn-default">Buscar</button>
				    </form>
				    {% if documentosDig %}
				    	{{ documentosDig }}
				    {% endif %}
				</div>
				<div class="col-md-3">
					<!-- Collect the nav links, forms, and other content for toggling -->
					<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
						
						<ul class="nav navbar-nav navbar-right">
							<li><a href="{% url 'sgc.views.home' %}">Inicio</a></li>
							<li><a href="" class="desplegable">Menú</a></li>
						</ul>
					</div><!-- /.navbar-collapse -->
				</div>
			</div>
			
		</div><!-- /.container-fluid -->
	</nav>

	<div id="map" style="width: 100%px; min-height: 100%"></div>

	<script src="http://leafletjs.com/dist/leaflet.js"></script>
	<!-- Jquery Library -->
	<script src="{% static 'sgc/js/jquery-2.1.3.js' %}"></script>

	<!-- Bootstrap Library -->
	<script src="{% static 'sgc/js/bootstrap.js' %}"></script>

	<script>
		var map = L.map('map').setView([11.0129931, -74.8334623], 13);

		L.tileLayer('https://{s}.tiles.mapbox.com/v3/{id}/{z}/{x}/{y}.png', {
			maxZoom: 18,
			attribution: '',
			id: 'examples.map-i875mjb7'
		}).addTo(map);

		$('.desplegable').click(function(e){
			e.preventDefault();
			$('.desplegable-window').toggle();
		});

		$(document).ready(function(){
			$('#formularioBusqueda').submit(function(e){
				e.preventDefault();

				$.post('{% url "sgc.views.busqueda" %}', {'busqueda_valor': $('#busqueda').val()}, function(response){
					if(response != 0 && response != null && response != "null"){
						$('#accordionlista_resultados').empty();
						$('#listaResultados').empty();

						$.each(response, function(key, value){
							var id = "", titulo = "", resumen = "", ruta_archivo = "", geometria = "";
							$.each(value, function(k,v){
								if(k == "id"){
									id = v;
								}
								if(k == "titulo"){
									titulo = v;
								}
								if(k == "resumen"){
									resumen = v.substring(0, 150) + "...";
								}
								if(k == "archivo"){
									ruta_archivo = v;
								}
								if(k == "geometria"){
									geometria = v;
									$.each(geometria, function(k1, v1){
										if(k1 == "coordinates"){
											var puntos = v1.reverse();
											var mark = L.marker(puntos).addTo(map);
										}
									});
								}
							});


							var htmlAccordion = '<div class="panel panel-default">';
								htmlAccordion += '<div class="panel-heading" role="tab" id="heading'+id+'">';
								htmlAccordion += '<h4 class="panel-title">';
								htmlAccordion += '<a data-toggle="collapse" data-parent="#accordion" href="#collapse'+id+'" aria-expanded="true" aria-controls="collapse'+id+'">';
								htmlAccordion += titulo;
								htmlAccordion += '</a>';
								htmlAccordion += '</h4>';
								htmlAccordion += '</div>';
								htmlAccordion += '<div id="collapse'+id+'" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading'+id+'">';
								htmlAccordion += '<div class="panel-body">';
								htmlAccordion += '<p>'+resumen+'</p>';
								htmlAccordion += '<hr />';
								htmlAccordion += '<h4><i class="glyphicon glyphicon-folder-open"></i> &nbsp; Documentos</h4>';
								htmlAccordion += '<p><a href="/media/'+ruta_archivo+'" style="margin-left:20px;"><i class="glyphicon glyphicon-file"></i>'+ruta_archivo+'</a></p>';
								htmlAccordion += '</div>';
								htmlAccordion += '</div>';
								htmlAccordion += '</div>';

							$('#accordionlista_resultados').append(htmlAccordion);
						});
					}else{
						$('#listaResultados').append('<p>No hay resultados.</p>');
					}
				});

				$('#resultadosBusquedaModal').modal('show');
			});
		});
	</script>
</body>
</html>
