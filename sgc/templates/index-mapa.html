{% load staticfiles %}
<!DOCTYPE html>
<html>
<head>
	<title>Mapa</title>
	<meta charset="utf-8" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="http://leafletjs.com/dist/leaflet.css" />

	<!-- Bootstrap-->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

	<!-- Bootstrap theme  -->
	<link rel="stylesheet" href="{% static 'sgc/css/bootstrap-theme.css' %}" />



	<style>
		html { padding-top: 50px; height: 100%; }
		body { height: 100%; position: relative; }
		.navbar-brand {
			height: 50px;
			padding: 5px;
		}
		.navbar-nav > li > a {
			line-height: 0px;
			padding-bottom: 22px;
		}
		.desplegable-window {
			position: absolute;
			top: 0;
			right: 0;
			width: 350px;
			height: 100%;
			z-index: 1001;
		}
		.bg-dark-blue label {
			color: white;
		}
		.navbar-default .navbar-nav > li > a {
			color: white;
		}
		.botonSearch {
			visibility: hidden;
		}
	</style>
	<!--###########################################################################################-->
		<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
		<!--[if lte IE 8]>
			<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.ie.css" />
		<![endif]-->

	<!--###########################################################################################-->
</head>
<body>
	
	<!-- Modal -->
	<div class="modal fade" id="resultadosBusquedaModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" id="myModalLabel">Resultados de búsqueda</h4>
				</div>
				<div class="modal-body">
					<div class="panel-group" id="accordionlista_resultados" role="tablist" aria-multiselectable="true">
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="chartModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" id="myModalLabel">Mediciones</h4>
				</div>
				<div class="modal-body">
					<div id="curve_chart" style="width: 900px; height: 500px"></div>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="documentosBusquedaModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" id="myModalLabel">Documentos de la búsqueda</h4>
				</div>
				<div class="modal-body">
					<div class="panel-group" id="accordionDocumentos_resultados" role="tablist" aria-multiselectable="true">
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="shapesBusquedaModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" id="myModalLabel">Shapes de la búsqueda</h4>
				</div>
				<div class="modal-body">
					<div class="panel-group" id="accordionShapes_resultados" role="tablist" aria-multiselectable="true">
					</div>
				</div>
			</div>
		</div>
	</div>


	<div class="desplegable-window" style="display:none;">
		<div class="panel panel-default bg-dark-blue">
			<div class="panel-body bg-dark-blue">
				<form action="" method="post">
					{% csrf_token %}
					<div class="form-group">
						<label for="combo1">Área temática</label>
						<select name="combo1" id="combo1" class="form-control">
							{% for area in areasTematicas %}
								<option value="{{ area.id }}">{{ area }}</option>
							{% endfor %}
						</select>
					</div>
					<div class="form-group">
						<input type="submit" name="submit" id="submitAreaTematica" class="btn btn-success form-control" value="Buscar" />
					</div>
					<hr />
					<div class="form-group">
						<label for="busqueda_cursor">
							<input type="checkbox" name="busqueda_cursor" id="busqueda_cursor" />
							Búsqueda por cursor	
						</label>
			        </div>
					<div class="form-group">
						<label for="demo">Rango de búsqueda (km)</label>
						<input id="demo" type="number" value="100" min="1" max="1000" class="form-control">
					</div>
				</form>
				
			</div>
		</div>
	</div>

	<nav class="navbar navbar-default navbar-fixed-top bg-dark-blue">
		<div class="container-fluid">
			<!-- Brand and toggle get grouped for better mobile display -->
			<div class="col-lg-12">
				<div class="col-md-2">
					<div class="navbar-header">
						<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
							<span class="sr-only">Toggle navigation</span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
						</button>
						
						<a href="{% url 'sgc.views.home' %}"><img src="{% static 'sgc/img/single-logo-borderWhite.png' %}" alt="" class="navbar-brand" /></a>
					</div>
				</div>
				<div class="col-md-6 text-center">
					<form class="navbar-form" role="search" id="formularioBusqueda" method="post">
				        <div class="form-group">
				          <input type="text" id="busqueda" class="form-control" placeholder="Búsqueda">
				        </div>
				        <button type="submit" class="btn btn-default">Buscar</button>
						
				        <button type="button" style="margin-left:5px;" class="btn btn-default" onclick="nuevaBusqueda();"><i class="glyphicon glyphicon-erase"></i></button>
				    </form>
				    {% if documentosDig %}
				    	{{ documentosDig }}
				    {% endif %}

				</div>
				<div class="col-md-4" style="padding:8px 5px 0 5px;">
					<!-- Collect the nav links, forms, and other content for toggling -->
					<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
						
						<ul class="nav navbar-nav navbar-right">
							<li><a href="#" data-target="#documentosBusquedaModal" data-toggle="modal" class="botonSearch"></a></li>
							<li><a href="#" data-target="#documentosBusquedaModal" data-toggle="modal" class="botonSearch">Ver Documentos</a></li>
							<li><a href="#" data-target="#shapesBusquedaModal" data-toggle="modal" class="botonSearch">Ver Shapes</a></li>
							<li><a href="{% url 'sgc.views.home' %}">Inicio</a></li>
							<li><a href="" class="desplegable">Menú</a></li>
						</ul>
					</div><!-- /.navbar-collapse -->
				</div>
			</div>
			
		</div><!-- /.container-fluid -->
	</nav>

	<div id="map" style="width: 100%px; min-height: 100%"></div>
	<!-- Jquery Library -->
	<script src="{% static 'sgc/js/jquery-2.1.3.js' %}"></script>

	<!-- Bootstrap Library -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
	<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
    <script src="{% static 'mapas/js/shp.js' %}"></script>
    <script src="{% static 'mapas/js/catiline.js' %}"></script>
    <script src="{% static 'mapas/js/leaflet.shpfile.js' %}"></script>
    <script type="text/javascript"
          src="https://www.google.com/jsapi?autoload={
            'modules':[{
              'name':'visualization',
              'version':'1',
              'packages':['corechart']
            }]
          }"></script>
	<script>

	     function viewChart(id){
	     	$.post("{% url 'sgc.views.getValoresMedicion' %}", {'idMedicion':id}, function(response){
	     		if(response != "" && response != "null" && response != null){
	     			var arrayData = [];
	     			$.each(response, function(key, value){
	     				var mes = "", medicion = 0, periodo = "";
	     				$.each(value, function(k,v){
	     					if(k == "fecha"){
	     						mes = v;
	     					}
	     					if(k == "valor"){
	     						medicion = v;
	     					}
	     				});
	     				arrayData.push([mes,medicion]);
	     			});	

	     			arrayData = [response];
	     			
	     			alert(arrayData);
	     			var data = new google.visualization.DataTable();
	     			data.addColumn('number', 'Período');
	     			data.addColumn('number', 'Medicion');
			        	
	     			data.addRows([
	     				
	     			]);

			        var options = {
			          title: 'Mediciones',
			          curveType: 'function',
			          legend: { position: 'bottom' },
			          width: 550,
		        	  height: 500
			        };

			        var chart = new google.visualization.LineChart(document.getElementById('curve_chart'));

			        chart.draw(data, options);
	     		}
	     	});

	     	$('#chartModal').modal('show');
	     }

		var mark = "";

		var array1 = 0;
		var array2 = 0;
		var array3 = 0;

		/*L.tileLayer('https://{s}.tiles.mapbox.com/v3/{id}/{z}/{x}/{y}.png', {
			maxZoom: 18,
			attribution: '',
			id: 'examples.map-i875mjb7'
		}).addTo(map);*/

		
		var cities = new L.LayerGroup();
		var shapese = new L.LayerGroup();


	    var mbAttr = 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
				'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
				'Imagery © <a href="http://mapbox.com">Mapbox</a>',
			mbUrl = 'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6IjZjNmRjNzk3ZmE2MTcwOTEwMGY0MzU3YjUzOWFmNWZhIn0.Y8bhBaUMqFiPrDRW9hieoQ';

	    var grayscale   = L.tileLayer(mbUrl, {id: 'mapbox.light', attribution: mbAttr}),
		    streets  = L.tileLayer(mbUrl, {id: 'mapbox.streets',   attribution: mbAttr});

		var map = L.map('map', {
			center: [11.0129931, -74.8334623],
			zoom: 8,
			layers: [grayscale, cities, shapese]
		});
		map.on('click', function(e) {
		    valor_busqueda="POINT("+e.latlng.lng+" "+ e.latlng.lat+")";
		    string_buscador = $('#busqueda').val();
		    rango_busqueda = $('#demo').val();
		    cities.clearLayers();
			shapese.clearLayers();		
		    if($('#busqueda_cursor').is(':checked')){
		    	$.post('{% url "sgc.views.search_point" %}', {'busqueda_valor': valor_busqueda, 'rango_busqueda':rango_busqueda, 'string_busqueda':string_buscador}, function(response){
			    	if(response != 0 && response != null && response != "null"){
						$('#accordionlista_resultados').empty();
						$('#listaResultados').empty();

						$.each(response[0], function(key, value){
							var id = "", titulo = "", resumen = "", geometria = "", puntos = "", documentos = [], documentos_shp = [], mediciones = [];
							$.each(value, function(k,v){
								if(k == "id"){
									id = v;
								}
								if(k == "titulo"){
									titulo = v;
								}
								if(k == "resumen"){
									resumen = v.substring(0, 150) + "...";
								}
								if(k == "geometria"){
									geometria = v;
									if(geometria != "None" && geometria != ""){
										geometriaArr = geometria.split(" ");
										valorLat = geometriaArr[1].substring(1, geometriaArr[1].length);
										valorLon = geometriaArr[2].substring(0, geometriaArr[2].length-1);
										puntos = [valorLon, valorLat, null];
									}

								}
								if(k == "locDoc"){
									$.each(v, function(k1, v1){
										documentos.push(v1);
									});
								}
								if(k == "locDocShp"){
									$.each(v, function(k1, v1){
										documentos_shp.push(v1);
									});
								}
								if(k == "locMed"){
									$.each(v, function(k1, v1){
										mediciones.push(v1);
									});
								}
							});

							var htmlAccordion = '<div class="panel panel-default">';
								htmlAccordion += '<div class="panel-heading" role="tab" id="heading'+id+'">';
								htmlAccordion += '<h4 class="panel-title">';
								htmlAccordion += '<a data-toggle="collapse" data-parent="#accordionlista_resultados" href="#collapse'+id+'" aria-expanded="true" aria-controls="collapse'+id+'">';
								htmlAccordion += titulo;
								htmlAccordion += '</a>';
								htmlAccordion += '</h4>';
								htmlAccordion += '</div>';
								htmlAccordion += '<div id="collapse'+id+'" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading'+id+'">';
								htmlAccordion += '<div class="panel-body">';
								htmlAccordion += '<p>'+resumen+'</p>';
								htmlAccordion += '<hr />';
								htmlAccordion += '<h4><i class="glyphicon glyphicon-folder-open"></i> &nbsp; Documentos digitales</h4>';
								for (var i = 0; i < documentos.length; i++) {
									htmlAccordion += '<p><a href="/media/'+documentos[i]+'" target="_blank"><i class="glyphicon glyphicon-file"></i> '+documentos[i]+'</a></p>';
								};
								htmlAccordion += '<hr />';
								htmlAccordion += '<h4><i class="glyphicon glyphicon-folder-open"></i> &nbsp; Archivos geográficos</h4>';
								for (var i = 0; i < documentos_shp.length; i++) {
									htmlAccordion += '<p><a href="#" onclick="loadshp(\''+documentos_shp[i]+'\');"><i class="glyphicon glyphicon-globe"></i> '+documentos_shp[i]+'</a></p>';
								};
								htmlAccordion += '<hr />';
								htmlAccordion += '<h4><i class="glyphicon glyphicon-scale"></i> &nbsp; Mediciones</h4>';
								for (var i = 0; i < mediciones.length; i++) {
									htmlAccordion += '<p><a href="#" onclick="viewChart();"><i class="glyphicon glyphicon-globe"></i> '+mediciones[i]+'</a></p>';
								};

								htmlAccordion += '</div>';
								htmlAccordion += '</div>';
								htmlAccordion += '</div>';



							var htmlMarkerPopup = '<div class="panel panel-default">';
								htmlMarkerPopup += '<div class="panel-heading" role="tab" id="heading'+id+'">';
								htmlMarkerPopup += '<h4 class="panel-title">';
								htmlMarkerPopup += titulo;
								htmlMarkerPopup += '</h4>';
								htmlMarkerPopup += '</div>';
								htmlMarkerPopup += '<div class="panel-body">';
								htmlMarkerPopup += '<p>'+resumen+'</p>';
								htmlMarkerPopup += '<hr />';
								htmlMarkerPopup += '<h5><i class="glyphicon glyphicon-folder-open"></i> &nbsp; Documentos digitales</h5>';
								for (var i = 0; i < documentos.length; i++) {
									htmlMarkerPopup += '<p><a href="/media/'+documentos[i]+'" target="_blank"><i class="glyphicon glyphicon-file"></i> '+cortarString(documentos[i])+'</a></p>';
								};
								htmlMarkerPopup += '<hr />';
								htmlMarkerPopup += '<h5><i class="glyphicon glyphicon-folder-open"></i> &nbsp; Archivos geográficos</h5>';
								for (var i = 0; i < documentos_shp.length; i++) {
									htmlMarkerPopup += '<p><a href="#" onclick="loadshp(\''+documentos_shp[i]+'\');"><i class="glyphicon glyphicon-globe"></i> '+cortarString(documentos_shp[i])+'</a></p>';
								};
								htmlMarkerPopup += '<hr />';
								htmlMarkerPopup += '<h4><i class="glyphicon glyphicon-scale"></i> &nbsp; Mediciones</h4>';
								for (var i = 0; i < mediciones.length; i++) {
									var medicionArr = mediciones[i].split('~');
									htmlMarkerPopup += '<p><a href="#" onclick="viewChart('+medicionArr[0]+');"><i class="glyphicon glyphicon-globe"></i> '+medicionArr[1]+'</a></p>';
								};
								htmlMarkerPopup += '</div>';
								htmlMarkerPopup += '</div>';
								htmlMarkerPopup += '</div>';


							mark = L.marker(puntos).addTo(cities).bindPopup(htmlMarkerPopup);

							$('#accordionlista_resultados').append(htmlAccordion);
						});

						$.each(response[1], function(key, value){
							$('.botonSearch').css('visibility', 'initial');
							$('#accordionDocumentos_resultados').empty();
							var id = "", titulo = "", resumen = "", geometria = "", archivo = "";
							$.each(value, function(k,v){
								if(k == "id"){
									id = v;
								}
								if(k == "titulo"){
									titulo = v;
								}
								if(k == "resumen"){
									resumen = v.substring(0, 150) + "...";
								}
								if(k == "geometria"){
									geometria = v;
									geometriaArr = geometria.split(" ");
									valorLat = geometriaArr[1].substring(1, geometriaArr[1].length);
									valorLon = geometriaArr[2].substring(0, geometriaArr[2].length-1);
									puntos = [valorLon, valorLat, null];
								}
								if(k == "archivo"){
									archivo = v;
								}
							});

							var htmlAccordion = '<div class="panel panel-default">';
								htmlAccordion += '<div class="panel-heading" role="tab" id="heading'+id+'">';
								htmlAccordion += '<h4 class="panel-title">';
								htmlAccordion += '<a data-toggle="collapse" data-parent="#accordionDocumentos_resultados" href="#collapse'+id+'" aria-expanded="true" aria-controls="collapse'+id+'">';
								htmlAccordion += titulo;
								htmlAccordion += '</a>';
								htmlAccordion += '</h4>';
								htmlAccordion += '</div>';
								htmlAccordion += '<div id="collapse'+id+'" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading'+id+'">';
								htmlAccordion += '<div class="panel-body">';
								htmlAccordion += '<p>'+resumen+'</p>';
								htmlAccordion += '<hr />';
								htmlAccordion += '<p><a href="/media/'+archivo+'" target="_blank"><i class="glyphicon glyphicon-file"></i> '+archivo+'</a></p>';
								htmlAccordion += '</div>';
								htmlAccordion += '</div>';
								htmlAccordion += '</div>';


							var htmlMarkerPopup = '<div class="panel panel-default">';
								htmlMarkerPopup += '<div class="panel-heading" role="tab" id="heading'+id+'">';
								htmlMarkerPopup += '<h4 class="panel-title">';
								htmlMarkerPopup += titulo;
								htmlMarkerPopup += '</h4>';
								htmlMarkerPopup += '</div>';
								htmlMarkerPopup += '<div class="panel-body">';
								htmlMarkerPopup += '<p>'+resumen+'</p>';
								htmlMarkerPopup += '<hr />';
								htmlMarkerPopup += '<p><a href="/media/'+archivo+'" target="_blank"><i class="glyphicon glyphicon-file"></i> '+cortarString(archivo)+'</a></p>';								
								htmlMarkerPopup += '</div>';
								htmlMarkerPopup += '</div>';
								htmlMarkerPopup += '</div>';


							mark = L.marker(puntos).addTo(cities).bindPopup(htmlMarkerPopup);
							$('#accordionDocumentos_resultados').append(htmlAccordion);
							
						});

						$.each(response[2], function(key, value){
							$('.botonSearch').css('visibility', 'initial');
							$('#accordionShapes_resultados').empty();
							var id = "", titulo = "", resumen = "", geometria = "", archivo = "";
							$.each(value, function(k,v){
								if(k == "id"){
									id = v;
								}
								if(k == "titulo"){
									titulo = v;
								}
								if(k == "resumen"){
									resumen = v.substring(0, 150) + "...";
								}
								if(k == "geometria"){
									geometria = v;
									if(geometria != "None" && geometria != ""){
										geometriaArr = geometria.split(" ");
										valorLat = geometriaArr[1].substring(1, geometriaArr[1].length);
										valorLon = geometriaArr[2].substring(0, geometriaArr[2].length-1);
										puntos = [valorLon, valorLat, null];
									}
								}
								if(k == "archivo"){
									archivo = v;
								}
							});

							var htmlAccordion = '<div class="panel panel-default">';
								htmlAccordion += '<div class="panel-heading" role="tab" id="heading2'+id+'">';
								htmlAccordion += '<h4 class="panel-title">';
								htmlAccordion += '<a data-toggle="collapse" data-parent="#accordionShapes_resultados" href="#collapse2'+id+'" aria-expanded="true" aria-controls="collapse2'+id+'">';
								htmlAccordion += titulo;
								htmlAccordion += '</a>';
								htmlAccordion += '</h4>';
								htmlAccordion += '</div>';
								htmlAccordion += '<div id="collapse2'+id+'" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading2'+id+'">';
								htmlAccordion += '<div class="panel-body">';
								htmlAccordion += '<p>'+resumen+'</p>';
								htmlAccordion += '<hr />';
								htmlAccordion += '<p><a href="#" onclick="loadshp(\''+archivo+'\');"><i class="glyphicon glyphicon-globe"></i> '+archivo+'</a></p>';
								htmlAccordion += '</div>';
								htmlAccordion += '</div>';
								htmlAccordion += '</div>';

							var htmlMarkerPopup = '<div class="panel panel-default">';
								htmlMarkerPopup += '<div class="panel-heading" role="tab" id="heading'+id+'">';
								htmlMarkerPopup += '<h4 class="panel-title">';
								htmlMarkerPopup += titulo;
								htmlMarkerPopup += '</h4>';
								htmlMarkerPopup += '</div>';
								htmlMarkerPopup += '<div class="panel-body">';
								htmlMarkerPopup += '<p>'+resumen+'</p>';
								htmlMarkerPopup += '<hr />';
								htmlMarkerPopup += '<p><a href="#" onclick="loadshp(\''+archivo+'\');"><i class="glyphicon glyphicon-globe"></i> '+cortarString(archivo)+'</a></p>';								
								htmlMarkerPopup += '</div>';
								htmlMarkerPopup += '</div>';
								htmlMarkerPopup += '</div>';

							mark = L.marker(puntos).addTo(cities).bindPopup(htmlMarkerPopup);
							$('#accordionShapes_resultados').append(htmlAccordion);
							
						});
							if(response[0].length > 0){
								$('#resultadosBusquedaModal').modal('show');
							}else if(response[1].length > 0 && response[0].length == 0){
								$('#documentosBusquedaModal').modal('show');
							}else if(response[2].length > 0 && response[0].length == 0 && response[1].length == 0){
								$('#shapesBusquedaModal').modal('show');
							}else{
								$('#listaResultados').append('<p>No hay resultados.</p>');
								$('#accordionlista_resultados').empty();
								$('#accordionlista_resultados').append('<p>No hay resultados</p>');
								$('#resultadosBusquedaModal').modal('show');
							}

					}else{
						$('#listaResultados').append('<p>No hay resultados.</p>');
						$('#accordionlista_resultados').empty();
						$('#accordionlista_resultados').append('<p>No hay resultados</p>');
						$('#resultadosBusquedaModal').modal('show');
					}
		    	});
		    }
		    
		});
		var baseLayers = {
			"Grayscale": grayscale,
			"Streets": streets
		};

		var overlays = {
			"Marcadores": cities
		};
		var lc = L.control.layers(baseLayers, overlays).addTo(map);

		$('.desplegable').click(function(e){
			e.preventDefault();
			$('.desplegable-window').toggle();
		});
	//<!--#################################################################{% static 'congress.zip' %}"##########################-->
function loadshp(rutaArchivo){

	var options = {
        onEachFeature: function(feature, layer) {
            if (feature.properties) {
                layer.bindPopup(Object.keys(feature.properties).map(function(k) {
                    if(k === '__color__'){
                        return;
                    }
                    return k + ": " + feature.properties[k];
                }).join("<br />"), {
                    maxHeight: 200
                });
            }
        },
        style: function(feature) {
            return {
                opacity: 1,
                fillOpacity: 0.7,
                radius: 6
            }
        },
        pointToLayer: function(feature, latlng) {
            return L.circleMarker(latlng, {
                opacity: 1,
                fillOpacity: 0.7,
                color: feature.properties.__color__
            });
        }
    };


		rutaArchivo = "/media/"+rutaArchivo;
		console.log(rutaArchivo);
		
		rutaArr = rutaArchivo.split('/');

		shp(rutaArchivo).then(function(geojson){
	        console.log(geojson);
	        lc.addOverlay(L.geoJson(geojson, options).addTo(map), rutaArr[rutaArr.length - 1]);
	    });
}
	
	function nuevaBusqueda(){
		location.reload(true);	
	}

		$(document).ready(function(){
			$('#formularioBusqueda').submit(function(e){
				e.preventDefault();

				var valor_busqueda = $('#busqueda').val();

				if(valor_busqueda != null && valor_busqueda != "null" && valor_busqueda != ""){
					$.post('{% url "sgc.views.search" %}', {'busqueda_valor': valor_busqueda}, function(response){
						if(response != 0 && response != null && response != "null"){
							$('#accordionlista_resultados').empty();
							$('#listaResultados').empty();
							
							$.each(response[0], function(key, value){
								var id = "", titulo = "", resumen = "", geometria = "", puntos = "", documentos = [], documentos_shp = [], mediciones = [];
								$.each(value, function(k,v){
									if(k == "id"){
										id = v;
									}
									if(k == "titulo"){
										titulo = v;
									}
									if(k == "resumen"){
										resumen = v.substring(0, 150) + "...";
									}
									if(k == "geometria"){
										geometria = v;
										if(geometria != "None" && geometria != ""){
											geometriaArr = geometria.split(" ");
											valorLat = geometriaArr[1].substring(1, geometriaArr[1].length);
											valorLon = geometriaArr[2].substring(0, geometriaArr[2].length-1);
											puntos = [valorLon, valorLat, null];
										}

									}
									if(k == "locDoc"){
										$.each(v, function(k1, v1){
											documentos.push(v1);
										});
									}
									if(k == "locDocShp"){
										$.each(v, function(k1, v1){
											documentos_shp.push(v1);
										});
									}
									if(k == "locMed"){
										$.each(v, function(k1, v1){
											mediciones.push(v1);
										});
									}
								});

								var htmlAccordion = '<div class="panel panel-default">';
									htmlAccordion += '<div class="panel-heading" role="tab" id="heading'+id+'">';
									htmlAccordion += '<h4 class="panel-title">';
									htmlAccordion += '<a data-toggle="collapse" data-parent="#accordionlista_resultados" href="#collapse'+id+'" aria-expanded="true" aria-controls="collapse'+id+'">';
									htmlAccordion += titulo;
									htmlAccordion += '</a>';
									htmlAccordion += '</h4>';
									htmlAccordion += '</div>';
									htmlAccordion += '<div id="collapse'+id+'" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading'+id+'">';
									htmlAccordion += '<div class="panel-body">';
									htmlAccordion += '<p>'+resumen+'</p>';
									htmlAccordion += '<hr />';
									htmlAccordion += '<h4><i class="glyphicon glyphicon-folder-open"></i> &nbsp; Documentos digitales</h4>';
									for (var i = 0; i < documentos.length; i++) {
										htmlAccordion += '<p><a href="/media/'+documentos[i]+'" target="_blank"><i class="glyphicon glyphicon-file"></i> '+documentos[i]+'</a></p>';
									};
									htmlAccordion += '<hr />';
									htmlAccordion += '<h4><i class="glyphicon glyphicon-folder-open"></i> &nbsp; Archivos geográficos</h4>';
									for (var i = 0; i < documentos_shp.length; i++) {
										htmlAccordion += '<p><a href="#" onclick="loadshp(\''+documentos_shp[i]+'\');"><i class="glyphicon glyphicon-globe"></i> '+documentos_shp[i]+'</a></p>';
									};
									htmlAccordion += '<hr />';
									htmlAccordion += '<h4><i class="glyphicon glyphicon-scale"></i> &nbsp; Mediciones</h4>';
									for (var i = 0; i < mediciones.length; i++) {
										var medicionArr = mediciones[i].split('~');
										htmlAccordion += '<p><a href="#" onclick="viewChart('+medicionArr[0]+');"><i class="glyphicon glyphicon-stats"></i> '+medicionArr[1]+'</a></p>';
									};

									htmlAccordion += '</div>';
									htmlAccordion += '</div>';
									htmlAccordion += '</div>';



								var htmlMarkerPopup = '<div class="panel panel-default">';
									htmlMarkerPopup += '<div class="panel-heading" role="tab" id="heading'+id+'">';
									htmlMarkerPopup += '<h4 class="panel-title">';
									htmlMarkerPopup += titulo;
									htmlMarkerPopup += '</h4>';
									htmlMarkerPopup += '</div>';
									htmlMarkerPopup += '<div class="panel-body">';
									htmlMarkerPopup += '<p>'+resumen+'</p>';
									htmlMarkerPopup += '<hr />';
									htmlMarkerPopup += '<h5><i class="glyphicon glyphicon-folder-open"></i> &nbsp; Documentos digitales</h5>';
									for (var i = 0; i < documentos.length; i++) {
										htmlMarkerPopup += '<p><a href="/media/'+documentos[i]+'" target="_blank"><i class="glyphicon glyphicon-file"></i> '+cortarString(documentos[i])+'</a></p>';
									};
									htmlMarkerPopup += '<hr />';
									htmlMarkerPopup += '<h5><i class="glyphicon glyphicon-folder-open"></i> &nbsp; Archivos geográficos</h5>';
									for (var i = 0; i < documentos_shp.length; i++) {
										htmlMarkerPopup += '<p><a href="#" onclick="loadshp(\''+documentos_shp[i]+'\');"><i class="glyphicon glyphicon-globe"></i> '+cortarString(documentos_shp[i])+'</a></p>';
									};
									htmlMarkerPopup += '<hr />';
									htmlMarkerPopup += '<h5><i class="glyphicon glyphicon-scale"></i> &nbsp; Mediciones</h5>';
									for (var i = 0; i < mediciones.length; i++) {
										var medicionArr = mediciones[i].split('~');
										htmlMarkerPopup += '<p><a href="#" onclick="viewChart('+medicionArr[0]+');"><i class="glyphicon glyphicon-stats"></i> '+medicionArr[1]+'</a></p>';
									};
									htmlMarkerPopup += '</div>';
									htmlMarkerPopup += '</div>';
									htmlMarkerPopup += '</div>';

								if(puntos != ""){
									mark = L.marker(puntos).addTo(cities).bindPopup(htmlMarkerPopup);
								}

								$('#accordionlista_resultados').append(htmlAccordion);
							});



							$.each(response[1], function(key, value){
								$('.botonSearch').css('visibility', 'initial');
								$('#accordionDocumentos_resultados').empty();
								var id = "", titulo = "", resumen = "", geometria = "", archivo = "";
								$.each(value, function(k,v){
									if(k == "id"){
										id = v;
									}
									if(k == "titulo"){
										titulo = v;
									}
									if(k == "resumen"){
										resumen = v.substring(0, 150) + "...";
									}
									if(k == "geometria"){
										geometria = v;
										geometriaArr = geometria.split(" ");
										valorLat = geometriaArr[1].substring(1, geometriaArr[1].length);
										valorLon = geometriaArr[2].substring(0, geometriaArr[2].length-1);
										puntos = [valorLon, valorLat, null];
									}
									if(k == "archivo"){
										archivo = v;
									}
								});

								var htmlAccordion = '<div class="panel panel-default">';
									htmlAccordion += '<div class="panel-heading" role="tab" id="heading'+id+'">';
									htmlAccordion += '<h4 class="panel-title">';
									htmlAccordion += '<a data-toggle="collapse" data-parent="#accordionDocumentos_resultados" href="#collapse'+id+'" aria-expanded="true" aria-controls="collapse'+id+'">';
									htmlAccordion += titulo;
									htmlAccordion += '</a>';
									htmlAccordion += '</h4>';
									htmlAccordion += '</div>';
									htmlAccordion += '<div id="collapse'+id+'" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading'+id+'">';
									htmlAccordion += '<div class="panel-body">';
									htmlAccordion += '<p>'+resumen+'</p>';
									htmlAccordion += '<hr />';
									htmlAccordion += '<p><a href="/media/'+archivo+'" target="_blank"><i class="glyphicon glyphicon-file"></i> '+archivo+'</a></p>';
									htmlAccordion += '</div>';
									htmlAccordion += '</div>';
									htmlAccordion += '</div>';


								var htmlMarkerPopup = '<div class="panel panel-default">';
									htmlMarkerPopup += '<div class="panel-heading" role="tab" id="heading'+id+'">';
									htmlMarkerPopup += '<h4 class="panel-title">';
									htmlMarkerPopup += titulo;
									htmlMarkerPopup += '</h4>';
									htmlMarkerPopup += '</div>';
									htmlMarkerPopup += '<div class="panel-body">';
									htmlMarkerPopup += '<p>'+resumen+'</p>';
									htmlMarkerPopup += '<hr />';
									htmlMarkerPopup += '<p><a href="/media/'+archivo+'"><i class="glyphicon glyphicon-file"></i> '+cortarString(archivo)+'</a></p>';								
									htmlMarkerPopup += '</div>';
									htmlMarkerPopup += '</div>';
									htmlMarkerPopup += '</div>';


								mark = L.marker(puntos).addTo(cities).bindPopup(htmlMarkerPopup);
								$('#accordionDocumentos_resultados').append(htmlAccordion);
								
							});

							$.each(response[2], function(key, value){
								$('.botonSearch').css('visibility', 'initial');
								$('#accordionShapes_resultados').empty();
								var id = "", titulo = "", resumen = "", geometria = "", archivo = "";
								$.each(value, function(k,v){
									if(k == "id"){
										id = v;
									}
									if(k == "titulo"){
										titulo = v;
									}
									if(k == "resumen"){
										resumen = v.substring(0, 150) + "...";
									}
									if(k == "geometria"){
										geometria = v;
										geometriaArr = geometria.split(" ");
										valorLat = geometriaArr[1].substring(1, geometriaArr[1].length);
										valorLon = geometriaArr[2].substring(0, geometriaArr[2].length-1);
										puntos = [valorLon, valorLat, null];
									}
									if(k == "archivo"){
										archivo = v;
									}
								});

								var htmlAccordion = '<div class="panel panel-default">';
									htmlAccordion += '<div class="panel-heading" role="tab" id="heading2'+id+'">';
									htmlAccordion += '<h4 class="panel-title">';
									htmlAccordion += '<a data-toggle="collapse" data-parent="#accordionShapes_resultados" href="#collapse2'+id+'" aria-expanded="true" aria-controls="collapse2'+id+'">';
									htmlAccordion += titulo;
									htmlAccordion += '</a>';
									htmlAccordion += '</h4>';
									htmlAccordion += '</div>';
									htmlAccordion += '<div id="collapse2'+id+'" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading2'+id+'">';
									htmlAccordion += '<div class="panel-body">';
									htmlAccordion += '<p>'+resumen+'</p>';
									htmlAccordion += '<hr />';
									htmlAccordion += '<p><a href="#" onclick="loadshp(\''+archivo+'\');"><i class="glyphicon glyphicon-globe"></i> '+archivo+'</a></p>';
									htmlAccordion += '</div>';
									htmlAccordion += '</div>';
									htmlAccordion += '</div>';

								var htmlMarkerPopup = '<div class="panel panel-default">';
									htmlMarkerPopup += '<div class="panel-heading" role="tab" id="heading'+id+'">';
									htmlMarkerPopup += '<h4 class="panel-title">';
									htmlMarkerPopup += titulo;
									htmlMarkerPopup += '</h4>';
									htmlMarkerPopup += '</div>';
									htmlMarkerPopup += '<div class="panel-body">';
									htmlMarkerPopup += '<p>'+resumen+'</p>';
									htmlMarkerPopup += '<hr />';
									htmlMarkerPopup += '<p><a href="#" onclick="loadshp(\''+archivo+'\');"><i class="glyphicon glyphicon-globe"></i> '+cortarString(archivo)+'</a></p>';								
									htmlMarkerPopup += '</div>';
									htmlMarkerPopup += '</div>';
									htmlMarkerPopup += '</div>';

								mark = L.marker(puntos).addTo(cities).bindPopup(htmlMarkerPopup);
								$('#accordionShapes_resultados').append(htmlAccordion);
								
							});
						
							if(response[0].length > 0){
								$('#resultadosBusquedaModal').modal('show');
							}else if(response[1].length > 0 && response[0].length == 0){
								$('#documentosBusquedaModal').modal('show');
							}else if(response[2].length > 0 && response[0].length == 0 && response[1].length == 0){
								$('#shapesBusquedaModal').modal('show');
							}else{
								$('#listaResultados').append('<p>No hay resultados.</p>');
								$('#accordionlista_resultados').empty();
								$('#accordionlista_resultados').append('<p>No hay resultados</p>');
								$('#resultadosBusquedaModal').modal('show');
							}

						}else{
							$('#listaResultados').append('<p>No hay resultados.</p>');
							$('#accordionlista_resultados').empty();
							$('#accordionlista_resultados').append('<p>No hay resultados</p>');
							$('#resultadosBusquedaModal').modal('show');
						}
					});
					
					


				}else{
					alert("Debe escribir algo para realizar una búsqueda");
				}

			});

			
			$('#submitAreaTematica').click(function(e){
				e.preventDefault();
				$.post("{% url 'sgc.views.busqueda' %}", {'area_busqueda': $('#combo1').val()}, function(response){
					if(response != "" && response != null && response != "null"){
						map.removeLayer(mark);
						$.each(response, function(key, value){
							var id="", geometria = [], titulo = "", resumen = "", puntos = "", locDocArr = [], locDocShpArr = [];
							$.each(value, function(k, v){
								if(k == "id"){
									id = v;
								}
								if(k == "geometria"){
									geometria = v;
									if(geometria != "None" && geometria != ""){
										geometriaArr = geometria.split(" ");
										valorLat = geometriaArr[1].substring(1, geometriaArr[1].length);
										valorLon = geometriaArr[2].substring(0, geometriaArr[2].length-1);
										puntos = [valorLon, valorLat, null];
									}
								}
								if(k == "titulo"){
									titulo = v;
								}
								if(k == "resumen"){
									resumen = v.substring(0,150) + "...";
								}
								if(k == "locDoc"){
									locDocArr = v;
								}
								if(k == "locDocShp"){
									locDocShpArr = v;
								}
							});


							var htmlMarkerPopup = '<div class="panel panel-default">';
									htmlMarkerPopup += '<div class="panel-heading" role="tab" id="heading'+id+'">';
									htmlMarkerPopup += '<h4 class="panel-title">';
									htmlMarkerPopup += titulo;
									htmlMarkerPopup += '</h4>';
									htmlMarkerPopup += '</div>';
									htmlMarkerPopup += '<div class="panel-body">';
									htmlMarkerPopup += '<p>'+resumen+'</p>';
									htmlMarkerPopup += '<hr />';
									htmlMarkerPopup += '<h5><i class="glyphicon glyphicon-folder-open"></i> &nbsp; Documentos digitales</h5>';
									for (var i = 0; i < locDocArr.length; i++) {
										htmlMarkerPopup += '<p><a href="/media/'+locDocArr[i]+'"><i class="glyphicon glyphicon-file"></i> '+cortarString(locDocArr[i])+'</a></p>';
									};
									htmlMarkerPopup += '<hr />';
									htmlMarkerPopup += '<h5><i class="glyphicon glyphicon-folder-open"></i> &nbsp; Archivos geográficos</h5>';
									for (var i = 0; i < locDocShpArr.length; i++) {
										htmlMarkerPopup += '<p><a href="#" onclick="loadShp(\''+locDocShpArr[i]+'\')"><i class="glyphicon glyphicon-globe"></i> '+cortarString(locDocShpArr[i])+'</a></p>';
									};
									htmlMarkerPopup += '</div>';
									htmlMarkerPopup += '</div>';
									htmlMarkerPopup += '</div>';


							mark = L.marker(puntos).addTo(cities).bindPopup(htmlMarkerPopup);
						});
					}
				});
			});
		});

	
		function cortarString(cadenaStr){
			if(cadenaStr.length > 35){
				return cadenaStr.substring(0, 35) + '...';
			}else{
				return cadenaStr;
			}
		}
		
	</script>
</body>
</html>
















							
